<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Espace Commercial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* (Garder ton style CSS existant ici, j'ajoute juste les boutons sp√©cifiques) */
        :root { --primary: #2563eb; --accent: #f97316; --text: #1e293b; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
        
        /* En-t√™te avec info user */
        header { grid-column: 1 / -1; background: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .logout-btn { background: #fee2e2; color: #991b1b; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; color: #475569; }
        select, input { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        .option-group { display: none; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .option-group.active { display: block; }
        .price-display { font-size: 3rem; font-weight: 700; color: var(--primary); font-family: 'Space Mono', monospace; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; background: #0f172a; color: white; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* Workflow Actions */
        .workflow-actions { margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px; }
        .workflow-step { margin-bottom: 15px; }
        .step-title { font-size: 0.85rem; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; }
        .btn-action { width: 100%; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .btn-compta { background: #dcfce7; color: #166534; } 
        .btn-atelier { background: #ffedd5; color: #9a3412; }
        .btn-email { background: #2563eb; color: white; }

        /* PDF Template (Hidden) */
        #pdf-template { display: none; padding: 40px; font-family: sans-serif; color: #333; background: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="margin:0;">üí† Simpact Commercial</h2>
            </div>
            <div class="user-info">
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </header>

        <div class="card">
            <h3>üõ†Ô∏è Configuration du Devis</h3>
            <div class="form-group"><label>Client</label><input type="text" id="client-name" placeholder="Nom du client..."></div>
            <div class="form-group">
                <label>Produit</label>
                <select id="product-type">
                    <option value="">-- S√©lectionner --</option>
                    <option value="flyer">Flyers</option>
                    <option value="carte">Cartes de visite</option>
                    </select>
            </div>
            <div class="form-group"><label>Quantit√©</label><input type="number" id="quantity" placeholder="Ex: 1000"></div>
            
            <div id="flyer-options" class="option-group">
                <label>Type</label>
                <select id="flyer-type"><option value="recto">Recto</option><option value="rectoVerso">R/V</option></select>
                <label>Papier</label>
                <select id="flyer-paper"><option value="couche-135-brillant">135g Brillant</option></select>
            </div>

            <button class="btn" onclick="calculateQuote()">‚ö° Calculer le prix</button>
        </div>

        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h3>üí∞ R√©sultat</h3>
            <div class="price-display"><span id="total-price">0.00</span> DT</div>
            <p style="color:#64748b; font-size:0.9rem;">Ref: <span id="quote-ref" style="font-family:monospace; font-weight:bold;">--</span></p>

            <div class="workflow-actions" id="workflow-panel" style="opacity: 0.5; pointer-events: none;">
                <div class="workflow-step">
                    <div class="step-title">1. Documents Internes</div>
                    <button class="btn-action btn-compta" onclick="generatePDF('compta')">üìÑ T√©l√©charger Bon de Commande (Compta)</button>
                    <button class="btn-action btn-atelier" onclick="generatePDF('prod')">üè≠ T√©l√©charger Fiche Atelier (Prod)</button>
                </div>
                
                <div class="workflow-step">
                    <div class="step-title">2. Finalisation</div>
                    <button class="btn-action btn-email" onclick="prepareEmail()">üìß Pr√©parer l'email de validation</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <div style="display:flex; justify-content:space-between; border-bottom:3px solid #333; padding-bottom:20px; margin-bottom:30px;">
            <div>
                <h1 id="pdf-doc-title" style="margin:0; font-size:24px; text-transform:uppercase;">TITRE DOCUMENT</h1>
                <p style="margin:5px 0;">R√©f: <span id="pdf-ref"></span> | Date: <span id="pdf-date"></span></p>
            </div>
            <div style="text-align:right;">
                <h2 style="margin:0; color:#2563eb;">SIMPACT</h2>
                <p style="margin:0; font-size:12px;">Impression Num√©rique & Offset</p>
            </div>
        </div>

        <div style="background:#f3f4f6; padding:15px; border-radius:5px; margin-bottom:20px;">
            <strong>Client :</strong> <span id="pdf-client"></span><br>
            <strong>Commercial :</strong> <span id="pdf-commercial"></span>
        </div>

        <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
            <tr style="background:#e5e7eb;">
                <th style="padding:10px; text-align:left; border:1px solid #ddd;">D√©signation</th>
                <th style="padding:10px; text-align:center; border:1px solid #ddd;">Quantit√©</th>
                <th class="price-col" style="padding:10px; text-align:right; border:1px solid #ddd;">Prix HT</th>
            </tr>
            <tr>
                <td style="padding:15px; border:1px solid #ddd;">
                    <strong id="pdf-prod"></strong><br>
                    <span id="pdf-desc" style="font-size:12px; color:#555;"></span>
                </td>
                <td style="padding:15px; text-align:center; border:1px solid #ddd; font-weight:bold; font-size:1.2em;" id="pdf-qty"></td>
                <td class="price-col" style="padding:15px; text-align:right; border:1px solid #ddd; font-weight:bold;" id="pdf-price"></td>
            </tr>
        </table>

        <div id="atelier-notes" style="display:none; border:2px dashed #f97316; padding:15px; margin-top:30px;">
            <h3 style="margin-top:0; color:#c2410c;">‚ö†Ô∏è INSTRUCTIONS DE PRODUCTION</h3>
            <ul style="line-height:1.5;">
                <li>Bien v√©rifier le fichier avant rippage.</li>
                <li>Respecter le papier indiqu√© : <strong id="pdf-paper-check"></strong></li>
                <li>Finition demand√©e : <span id="pdf-finish-check"></span></li>
            </ul>
        </div>
    </div>

    <script>
        // 1. S√âCURIT√â : V√©rifier l'acc√®s au chargement
        const user = checkAuth('commercial'); // Vient de users.js
        if(user) document.getElementById('user-name-display').textContent = user.name;

        // 2. CONFIGURATION & CALCULS (Ins√©rer ici ta logique existante de calcul de prix)
        // ... (Tu peux copier-coller tes fonctions loadPrices, calculateQuote, etc.) ...
        
        let currentQuoteData = null;

        function calculateQuote() {
            // ... (Ta logique de calcul existante) ...
            
            // SIMULATION DU R√âSULTAT POUR L'EXEMPLE
            const price = 150.00; // Remplace par ta variable totalPrice
            const ref = "D-" + Date.now().toString().slice(-6);
            
            document.getElementById('total-price').textContent = price.toFixed(2);
            document.getElementById('quote-ref').textContent = ref;
            
            // Activer le panneau Workflow
            document.getElementById('workflow-panel').style.opacity = "1";
            document.getElementById('workflow-panel').style.pointerEvents = "auto";

            // Sauvegarder les donn√©es pour les PDFs
            currentQuoteData = {
                ref: ref,
                client: document.getElementById('client-name').value || "Client Comptoir",
                prod: document.getElementById('product-type').value,
                desc: "Description technique compl√®te...", // Construire cette string dynamiquement
                qty: document.getElementById('quantity').value,
                price: price.toFixed(2) + " DT",
                user: user.name,
                rawPrice: price
            };
        }

        // 3. G√âN√âRATION PDF INTELLIGENTE
        function generatePDF(type) {
            const el = document.getElementById('pdf-template');
            el.style.display = 'block'; // Afficher temporairement

            // Remplir les donn√©es communes
            document.getElementById('pdf-ref').textContent = currentQuoteData.ref;
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();
            document.getElementById('pdf-client').textContent = currentQuoteData.client;
            document.getElementById('pdf-commercial').textContent = currentQuoteData.user;
            document.getElementById('pdf-prod').textContent = currentQuoteData.prod.toUpperCase();
            document.getElementById('pdf-desc').textContent = currentQuoteData.desc;
            document.getElementById('pdf-qty').textContent = currentQuoteData.qty;

            if (type === 'compta') {
                // Mode BON DE COMMANDE (Avec Prix)
                document.getElementById('pdf-doc-title').textContent = "BON DE COMMANDE";
                document.getElementById('pdf-doc-title').style.color = "#2563eb"; // Bleu
                document.querySelectorAll('.price-col').forEach(e => e.style.display = 'table-cell');
                document.getElementById('pdf-price').textContent = currentQuoteData.price;
                document.getElementById('atelier-notes').style.display = 'none';
            } else {
                // Mode FICHE ATELIER (Sans Prix, avec instructions)
                document.getElementById('pdf-doc-title').textContent = "ORDRE DE FABRICATION";
                document.getElementById('pdf-doc-title').style.color = "#ea580c"; // Orange
                document.querySelectorAll('.price-col').forEach(e => e.style.display = 'none');
                document.getElementById('atelier-notes').style.display = 'block';
                // Remplir les d√©tails techniques sp√©cifiques ici
            }

            // G√©n√©rer et T√©l√©charger
            const opt = {
                margin: 10,
                filename: `Simpact_${type}_${currentQuoteData.ref}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(el).set(opt).save().then(() => {
                el.style.display = 'none'; // Cacher apr√®s
            });
        }

        // 4. PR√âPARATION DE L'EMAIL
        function prepareEmail() {
            const subject = encodeURIComponent(`Commande Simpact ${currentQuoteData.ref} - ${currentQuoteData.client}`);
            const body = encodeURIComponent(
`Bonjour,

Veuillez trouver ci-joint les documents pour la commande r√©f√©rence ${currentQuoteData.ref}.

Client : ${currentQuoteData.client}
Produit : ${currentQuoteData.prod}
Quantit√© : ${currentQuoteData.qty}
Prix valid√© : ${currentQuoteData.price}

Fichiers √† joindre manuellement :
1. Bon de commande (Compta)
2. Fiche Atelier (Prod)

Cordialement,
${user.name}`
            );
            
            window.location.href = `mailto:compta@simpact.tn,atelier@simpact.tn?subject=${subject}&body=${body}`;
        }
    </script>
</body>
</html>
